#!/usr/bin/env bash

# C++ Compile and Execute Shell
# chmod +x calpisで実行権限を与える
# ./calpisで実行可能

usage() {
  echo "Usage: ${0##*/} [-f] file" 1>&2
  exit 1
}

compile() {
  g++ $1 -o ${1%.*}.o && ./${1%.*}.o
}

force_compile() {
  echo "Recognized option f"
  echo "-------------------"
  compile $1
}

check_compile() {
  # オプション無しなら.oが存在するか確認して、あるなら.oのみを実行
  if [[ -f ${1%.*}.o ]]; then
    echo ".o already exists"
    echo "-----------------"
    ./${1%.*}.o
  # .oがないならコンパイルと実行を行う
  else
    echo ".o does not exist"
    echo "-----------------"
    compile $1
  fi
}

while getopts fh OPT
do
  case $OPT in
    # -f オプションを検知したら強制的にコンパイルと実行を行う
    f ) FORCE=1 ;;
    h ) usage ;;
    \? ) usage ;;
  esac
done

shift $((OPTIND - 1))

if [[ -n $FORCE ]]; then
  force_compile $1
else
  check_compile $1
fi
